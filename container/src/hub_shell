#!/usr/bin/bash

source .env

user_pool_file="./user_pool"
count=0
if test ! -e ./user_pool
then 
  touch ./user_pool
  echo "$USERNAME$count" >> $user_pool_file
fi


username=${USERNAME}
while grep -q "${USERNAME}${count}" $user_pool_file
do 
  count=`expr $count + 1`
  username="${USERNAME}${count}"
done
echo -n "$username" >> $user_pool_file
user_pass="test2"

sudo useradd $username
sudo sed -i -e "s/\/bin\/sh/\/usr\/bin\/bash/" /etc/passwd
sudo mkdir "/home/$username"
sudo chown -R $username:$username "/home/$username/"
sudo chmod -R 750 "/home/$username"
echo "$username:$user_pass" | sudo chpasswd
sudo -u $username -i

sudo rm -rf "/home/$username"
sudo userdel $username
sed -i -e "s/$username//" $user_pool_file
